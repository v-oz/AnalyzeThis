# AnalyzeThis
_YA moshelper web interface_

Базируется на [API Яндекс.Карт](https://tech.yandex.ru/maps/)

## Свистелки-перделки
* Отображение фиксаций на Я.Карте с группировкой в виде кластеров-диаграмм по типам нарушений или статусам
* Поиск-фильтр по ГРЗ с применением [RegExp](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp) (по желанию) - комбинируется с остальными фильтрами
* Фильтры:
  * по типам нарушений
  * по статусам фиксаций
  * по возрасту фиксации (срок от текущего момента)
  * по автору фиксации (различаются имена, но не UID пользователя)
 * Загрузка данных из локального файла
 * Загрузка данных с сервера
 * Обновление уже загруженных данных при последовательной загрузке нескольких наборов данных
 
 ## Входные данные
 Возможен импорт данных в двух форматах:
 * CSV - данные, экспортируемые из ПМ мифической кнопкой
 * JSON - данные, получаемые из ПМ ректальным методом через приложение в каталоге apk
 
Плюшки|CSV|JSON
------|---|----
Тип нарушения|+|+
Статус фиксации|+|+
Дата, время фиксации|+|+
ГРЗ|+|+
Координаты|+|+
Адрес|+|-
Всего штрафов этого ГРЗ|-|+
Всего фиксаций этого ГРЗ|-|+
Фото авто|+|+
Фото ГРЗ|+|+
Фото Знака(3.27, 3.28)|+|+
Ник автора|-|+
Время, затраченное на фиксацию|-|+
 
### CSV 
```csv 
 ID;"Номер авто";Дата;Координата;Вид_нарушения;Статус;Адрес
1123534;E606PX190;"2018.07.31 18:54:29";55.88828,37.66218;"В зоне действия знака «Остановка запрещена»";Оштрафован;"г. Москва, улица Грекова, дом 13А по Широкая улица"
```
### JSON
 [Формат JSON-описания объектов](https://tech.yandex.ru/maps/doc/jsapi/2.1/dg/concepts/object-manager/frontend-docpage/#concept_csl_v4p_fbb)

Данные поступают в виде коллекции объектов. 
В каждом объекте хранится информация о фиксации и её авторе, доступная из локальной БД ПАК ПМ на ОС Android. 

```json
{"type": "FeatureCollection",
    "features": [
     {"type": "Feature", 
         "id": 800170, 
         "geometry": {"type": "Point", "coordinates": [37.527294, 55.83938]}, 
         "properties": {
            "data":{
                "moshelper": {"uid": 12345, "name": "Penguin", "picture": "http://pakpm.mos.ru/img/ava/c4d5aad4d24a2b093a5564fa547a46b8.jpeg" },
                "auto_number": "k111bm197",
                "photo": "http://pakpm.mos.ru//img/j/16032018/09/800170/small/672004aa346f1b3a3d5aa6a236d5ac0b.jpeg",
                "status": 3,
                "type" : 1,
                "date": 1521181612000,
                "updated": 1521181677000,
                "fined_times": 10,
                "fix_times": 10
            }
        }
    },   
    ...
]}

```
Коллекции можно сливать в одну средствами сервера и выдавать по запросу пользователя как все подряд, так и заранее отфильтрованные. В данной реализации интерфейса фильтрация происходит на стороне клиента. Максимальное количество загруженных объектов зависит от устройства и не выяснялось. Напишите мне о своих результатах.

### Загрузка данных из локального файла
Нажатием кнопки _Файл_ открываем диалог выбора файла на устройстве. Файл должен быть сформирован по одному из вышеописанных форматов через приложение для Android в каталоге [apk](/apk) или иным способом. Поддерживается CSV из ПАК ПМ.

### Загрузка данных с сервера
В строку поиска **на карте** ввести URL файла с данными в виде <JSON:URL>, где URL - ссылка на файл вида _https://example.org/path/to/file.json_

Коллекцию объектов можно на лету формировать сервером, можно складывать свои файлы на GitHub или ином хостинге. GitHub в режиме просмотра показывает фиксации в виде точек на карте, а в режиме <RAW> отдает файл, как есть. Именно ссылку на RAW можно запрашивать из веб-интерфейса.
  
## Диаграммы и фильтры
Статистика по фиксациям представлена в виде круговых псевдо-диаграмм. На определенном масштабе группа фиксаций объединяется в один кластер, в котором отображается общее количество точек в кластере и распределение по категориям в виде круговой диаграммы. Подсчет идет по цветам. Каждой категории присвоен определенный цвет. **Легенды пока нет**. Изменение коэффициента _кучкования_ точек в кластеры производится выбором одного из трех элементов в выпадающем списке _Размер кластера_.

Фильтры - это выпадающие списки категорий. Загруженный набор данных можно отфильтровать по 4 критериям. Критерий _Возраст фиксации_ - это диапазоны времени прошедшего с момента фиксации до момента просмотра. Прямое указание периода не реализовано.

## Установка
В ОС Android устанавливается приложение для формирования набора данных. [Описание](https://telegra.ph/Kabinetec-nuzhnyj-v30-07-05)

Веб-интерфейс копируется на устройство и в браузере открывается [map.html](/map.html)

Лучше клонировать с GitHub и отслеживать изменения с какой-либо ветки проекта. Пулреквесты приветствуются. Особенно в части дизайна.

## TODO
- [ ] легенда диаграмм цветом в выпадающих списках
- [x] изменяемый коэффициент кластеризации фиксаций
- [ ] фильтр периода даты фиксации через строку поиска
- [x] поддержка CSV из ПАК ПМ
- [ ] при импорте обновлений из CSV или JSON из apk сообщать о смене статуса фиксации с _отклонено_ или _некач_ на _оштрафован_ или с _оштрафован_ на _обжаловано_
- [ ] сохраняемые в JSON-файле пользовательские теги с фильтром _Облако тегов_
